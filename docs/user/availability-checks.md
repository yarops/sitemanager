# Функционал проверок доступности сайтов

## Обзор

Система мониторинга сайтов предоставляет автоматизированный функционал для проверки доступности веб-сайтов и серверов. Система использует асинхронную обработку через очереди задач для обеспечения надежности и производительности.

## Основные компоненты

### 1. Модели данных

#### Check (common/models/Check.php)
Модель для хранения результатов проверок доступности:
- `id` - уникальный идентификатор проверки
- `job_id` - идентификатор задачи в очереди
- `item_id` - идентификатор проверяемого сайта
- `check_status` - HTTP статус код ответа
- `check_date` - дата и время проверки
- `response_time` - время отклика в миллисекундах
- `error_message` - сообщение об ошибке (если есть)

#### Item (common/models/Item.php)
Модель сайта с поддержкой мониторинга:
- `check_enabled` - флаг включения мониторинга (0/1)
- `publish_status` - статус публикации сайта
- Автоматическая постановка в очередь при включении мониторинга

### 2. Компоненты проверки

#### WorkerCheck (common/components/check/WorkerCheck.php)
Основной воркер для выполнения проверок доступности:

**Функциональность:**
- Выполнение HTTP HEAD запросов к сайтам
- Проверка множественных эндпоинтов для WordPress сайтов
- Измерение времени отклика
- Сохранение результатов в базу данных
- Отправка уведомлений при недоступности

**Эндпоинты для проверки:**
- `/wp-json/custom/v1/status` - кастомный API статуса
- `/wp-sitemap.xml` - карта сайта WordPress
- `/wp-admin/` - административная панель
- `/` - главная страница

**Параметры HTTP запроса:**
- Метод: HEAD
- Таймаут: 30 секунд
- User-Agent: SiteMonitor/1.0
- Максимум редиректов: 5
- Следование редиректам: включено

### 3. Система уведомлений

#### SiteNotification (common/components/SiteNotification.php)
Компонент для отправки уведомлений о состоянии сайтов:

**Типы уведомлений:**
- Уведомления о недоступности сайта
- Уведомления о восстановлении сайта
- Ежедневные отчеты мониторинга

**Формат уведомлений:**
- HTML-шаблоны с детальной информацией
- Включение времени отклика, статуса, ошибок
- Отправка на email: admin@devgamescom.local

### 4. Консольные команды

#### SiteMonitorController (console/controllers/SiteMonitorController.php)
Контроллер для ручного управления мониторингом:

**Команды:**
- `php yii site-monitor/check-all` - проверка всех активных сайтов
- Ручная проверка с выводом результатов в консоль
- Статистика проверок (всего, успешных, неудачных)

#### QueueController (console/controllers/QueueController.php)
Контроллер для управления очередями:

**Команды:**
- `php yii queue/setup-daily-monitoring` - настройка ежедневного мониторинга
- `php yii queue/enable-all-monitoring` - включение мониторинга для всех сайтов
- Планирование проверок на следующий день в 6:00

### 5. Веб-интерфейс

#### ServerController (frontend/controllers/ServerController.php)
Контроллер для проверки серверов через веб-интерфейс:

**Функции:**
- `actionCheckOnline()` - проверка всех доменов сервера
- Сохранение результатов в модель ServerCheck
- Отображение результатов проверки

## Автоматизация

### Настройка cron задач

Скрипт `setup_cron.sh` настраивает автоматическое выполнение проверок:

```bash
# Запуск в 6:00 каждый день
0 6 * * * cd /path/to/project && php yii queue/setup-daily-monitoring >> /path/to/project/runtime/logs/site-monitor.log 2>&1
```

### Очереди задач

Система использует Yii2 Queue для асинхронной обработки:
- Задачи ставятся в очередь при включении мониторинга
- Воркеры обрабатывают задачи в фоновом режиме
- Автоматическое планирование следующих проверок

## Процесс работы

### 1. Включение мониторинга
1. Пользователь включает флаг `check_enabled` для сайта
2. Срабатывает событие `afterSave()` в модели Item
3. Задача WorkerCheck ставится в очередь

### 2. Выполнение проверки
1. Воркер получает задачу из очереди
2. Выполняется HTTP HEAD запрос к сайту
3. Проверяются альтернативные эндпоинты при неудаче
4. Измеряется время отклика
5. Результат сохраняется в базу данных

### 3. Обработка результатов
1. При статусе != 200 отправляется уведомление
2. Логируется информация о проверке
3. Планируется следующая проверка (через cron)

### 4. Ежедневное планирование
1. Cron запускает команду в 6:00
2. Находятся все активные сайты с включенным мониторингом
3. Для каждого сайта планируется проверка на следующий день
4. Задачи ставятся в очередь с задержкой

## Мониторинг и логирование

### Логи
- Основные логи: `runtime/logs/site-monitor.log`
- Логи очереди: стандартные логи Yii2
- Детальная информация о каждой проверке

### Статистика
- Общее количество проверок
- Количество успешных/неудачных проверок
- Среднее время отклика
- Список недоступных сайтов

## Настройка и использование

### Запуск системы мониторинга

1. **Настройка cron:**
```bash
./setup_cron.sh
```

2. **Запуск воркера очереди:**
```bash
php yii queue/listen
```

3. **Включение мониторинга для сайтов:**
- Через веб-интерфейс: установить флаг "Check enabled"
- Через консоль: `php yii queue/enable-all-monitoring`

### Ручные проверки

1. **Проверка всех сайтов:**
```bash
php yii site-monitor/check-all
```

2. **Проверка сервера через веб-интерфейс:**
- Перейти в раздел "Серверы"
- Выбрать сервер
- Нажать "Проверить онлайн"

### Мониторинг состояния

1. **Просмотр логов:**
```bash
tail -f runtime/logs/site-monitor.log
```

2. **Статус очереди:**
```bash
php yii queue/info
```

3. **Просмотр результатов в веб-интерфейсе:**
- Раздел "Сайты" с фильтрацией по статусу
- Детальная информация о последних проверках

## Фильтрация и поиск

Система предоставляет фильтры для просмотра сайтов:
- `enabled` - сайты с включенным мониторингом
- `disabled` - сайты с отключенным мониторингом
- `up` - доступные сайты (статус 200)
- `down` - недоступные сайты (статус != 200)
- `never_checked` - сайты, которые никогда не проверялись

## Безопасность и производительность

### Ограничения
- Таймаут запросов: 30 секунд
- Максимум редиректов: 5
- Использование HEAD запросов для экономии трафика

### Обработка ошибок
- Graceful handling сетевых ошибок
- Логирование всех исключений
- Автоматические повторы через планировщик

### Масштабируемость
- Асинхронная обработка через очереди
- Возможность запуска нескольких воркеров
- Распределение нагрузки по времени
